/** https://github.com/empty125/treeview-dnd.js @license http://www.apache.org/licenses/LICENSE-2.0 @author xilei **/
(function(b,a){if(typeof define==="function"&&define.cmd){define(function(d,c,e){a(e.exports={},d("jquery"))})}else{a(b.TreeDnd={},jQuery)}})(this,function(c,b){var a={_doc:b(window.document),_initd:false,_items:[],_lastHit:"",_lastSelected:"",_draghoverCls:"",_copy:"",_target:"",_appendType:"",_clsHandlers:{},_timer:"",dropDisableCls:"dropdisabled",_dropCls:[],_countId:1,_newHtml:['<li class="edit-element expand" {#attrs}>','<div class="{#cls} expand-header level{#level}-header">','<div class="item-label">{#icon}<span class="title">{#title}</span></div>','<div class="ct-controls">{#controls}</div>',"</div>",'<div class="insert" style=""></div>','<ul style="display:{#expand}">{#children}</ul>',"</li>"].join(""),_dragoffset:{},initDrop:function(e){var d=this;d._dropCls.push(e);b(e).each(function(f){var g=b(this);d.setArea(g);g.data("dnd_id",d._countId++);d._items.push(g)})},setArea:function(e){var f=e.offset();var d=e.outerHeight();e.area={top:f.top,bottom:f.top+e.outerHeight(),left:f.left,right:f.left+e.outerWidth(),middle:f.top+d/2};e.dndparent=e.parent();e.dndlevel=e.dndparent.attr("data-level")||1;return e},setDisabled:function(e){if(!e){return false}var d=this._getHandle(e);if(!d){return false}if(d.targetCls){e.parent().addClass(d.targetCls)}if(d.dropabled){e.find(this._dropCls.join(",")).addClass(this.dropDisableCls)}return e},setEnabled:function(e){if(!e){return false}var d=this._getHandle(e);if(!d){return false}if(d.targetCls){e.parent().removeClass(d.targetCls)}if(d.dropabled){e.find(this._dropCls.join(",")).removeClass(this.dropDisableCls)}return e},updateArea:function(){var e=0,d=this;for(;e<d._items.length;e++){d.setArea(d._items[e]);d._items[e].data("dnd_id",e+1)}d._countId=d._items.length==0?1:d._items.length},removeItem:function(e){var d=e.data("dnd_id");e.parent().remove();if(d){this._items.splice(d-1,1);this.updateArea()}},addItem:function(d,f){if(!d||!f){return false}f.attr("data-group",d);var e=this._getHandle(f);if(f.length>0&&e){this.setArea(f);f.data("dnd_id",this._countId++);this._bindDrag(f,e);this._items.push(f);this.bindExEvent(f)}},setCurrentItem:function(d,e){this._copy=e;this._target=this.setArea(d);this.setDisabled(this._target)},checkCrash:function(e,d){return e.middle<=d.bottom&&e.middle>=d.top&&!(e.right<d.left||e.left>d.right)},checkDropEnable:function(d){if(!d||!d.dndlevel){return false}if(this._target.data("dnd_id")==d.data("dnd_id")||d.hasClass(this.dropDisableCls)){return false}return true},checkHit:function(){var e=this;e.setArea(e._copy);var f=e._getHandle(e._target);var d=0;if(!f){return false}if(e._lastHit&&e._draghoverCls){e._lastHit.removeClass(e._draghoverCls);e._lastHit=null}for(;d<e._items.length;d++){if(e.checkCrash(e._copy.area,e._items[d].area)){if(e._lastHit&&e._draghoverCls){e._lastHit.removeClass(e._draghoverCls)}if(e.checkDropEnable(e._items[d])){switch(e._items[d].dndlevel-e._target.dndlevel){case 0:e._appendType="after";break;case -1:e._appendType="insert";break;default:e._lastHit=null;continue}e._items[d].addClass(f.draghoverCls);e._draghoverCls=f.draghoverCls;e._lastHit=e._items[d];break}}}},updateItem:function(){var d=this._getHandle(this._target);if(!d){return false}if(this._target&&this._lastHit){if(b.type(d.drop)!="function"){d.drop=this._defaultDrop}d.drop.call(this,this._appendType,this._target,this._lastHit);this.updateArea()}if(this._lastHit&&this._draghoverCls){this._lastHit.removeClass(this._draghoverCls)}this.setEnabled(this._target);this._lastHit=null;this._target=null;this._draghoverCls=""},dragabled:function(d,e){if(!d||!e){return}this._clsHandlers[d]=e;if(e.dropabled){this.initDrop(d)}var f=b(d).attr("data-group",d);this._bindDrag(f,e);if(!this._initd){this._bindDocEvent();this._initd=true}if(e.events){this.bindExEvent(f,e.events)}},getDropItems:function(){return this._items},bindExEvent:function(g,e){var f=this._getHandle(g);if(!f||!f.events){return}if(!e){e=f.events}for(var d in e){if(b.type(e[d])=="function"){g.bind(d,{dnd:this,handle:f},e[d])}}},_defaultDrop:function(d,f,e){switch(d){case"after":e.parent().after(f.parent());break;case"insert":e.siblings("ul").append(f.parent());break}},_bindDrag:function(e,d){e.bind("mousedown",{dnd:this,handle:d},function(g){if(g.button===2){return false}g.stopPropagation();g.preventDefault();var h=b(this);var f=g.data.dnd;f._timer=setTimeout(function(){if(f._timer){clearTimeout(f._timer);f._timer=null}var j=h.clone(false);var i=h.position();var k={X:g.clientX-i.left,Y:g.clientY-i.top};h.parent().append(j);j.css({position:"absolute",width:h.width(),height:h.height(),"z-index":9999}).hide();if(g.data.handle.draggingCls){j.addClass(g.data.handle.draggingCls)}f._dragoffset=k;f.setCurrentItem(h,j);if(b.type(d.drag)=="function"){d.drag.call(g.data.dnd)}},100)})},_bindDocEvent:function(){this._doc.bind("mousemove",{dnd:this},function(f){f.stopPropagation();var d=f.data.dnd;if(d._timer){clearTimeout(d._timer);d._timer=null}if(!d._copy){return}var g=d._dragoffset;d._copy.css({top:f.clientY-g.Y,left:f.clientX-g.X}).show();d.checkHit()}).bind("mouseup",{dnd:this},function(f){f.stopPropagation();var d=f.data.dnd;if(d._timer){clearTimeout(d._timer);d._timer=null;return}if(!d._copy){return}d._copy.remove();d.updateItem()});b(window).bind("resize",{dnd:this},function(d){d.data.dnd.updateArea()})},_getHandle:function(d){if(!d){return false}return this._clsHandlers[d.attr("data-group")]},destory:function(){}};a.levelsAttr=[{icon:'<span class="label-icon label-icon-1"></span>',title:"新的一级节点",cls:"item-labelbox",expand:true},{icon:'<span class="label-icon label-icon-2 expand-icon"></span>',title:"新的二级节点",cls:"item-labelbox",expand:true},{icon:'<span class="label-icon label-icon-3"></span>',title:"新的三级节点",cls:"item-labelbox",expand:true},{icon:'<span class="label-icon label-icon-4"></span>',title:"新的四级节点",cls:"item-labelbox",expand:true}];a.createNewLevel=function(k,d,h){h=h||false;d=d||{};var j={},g=1;if(!isNaN(k)){if(!this.levelsAttr[k-1]){return false}for(f in d){j["data-"+f]=d[f]}j["data-level"]=k;g=k;k=b.extend({},this.levelsAttr[k-1])}else{if(!d.level){return false}var j=[],f="";for(f in d){j.push("data-"+f+'="'+d[f]+'"')}g=d.level;k.attrs=j.join(" ")}k.level=g;k.expand=k.expand===undefined||k.expand?"block":"none";delete d;var e=a._newHtml.replace(/\{\#(\w+)\}/g,function(i,l){if(k[l]){return k[l]}else{return""}});return !h?b(e).attr(j):e};a.render=function(h,k,d){if(!h){return false}if(d&&d.controls){this._newHtml=this._newHtml.replace("{#controls}",d.controls)}var f=0,j=[],g="";for(;f<h.length;f++){g=this._render(h[f],1);if(g){j.push(g)}}var e="<ul>"+j.join("")+"</ul>";if(!k){return e}k.html(e)};a._render=function(g,k){if(!g||!k){return""}var f="",e=0,d={},h=[];g=b.extend({},a.levelsAttr[k-1],g);for(f in g){if(f=="children"&&g[f]){for(e=0;e<g[f].length;e++){h.push(a._render(g[f][e],k+1))}g.children=h.join("")}if(f=="attrs"){d=g[f]}}d.level=k;return a.createNewLevel(g,d,true)};b.extend(c,a)});